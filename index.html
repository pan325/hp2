<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八卦密室逃脱</title>
   <!-- Open Graph 卡片信息 -->
    <meta property="og:title" content="八卦密室逃脱">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pan325.github.io/hp2/">
    <meta property="og:image" content="https://pan325.github.io/hp2/tanglaoya.jpg">
    <meta property="og:description" content="你被困在八卦密室，完成任务拿钥匙，赶紧逃脱！">
 <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',      // 紫色 - 主题色
                        secondary: '#EC4899',    // 粉色 - 辅助色
                        locked: '#4B5563',       // 灰色 - 锁定状态
                        current: '#F59E0B',      // 琥珀色 - 当前可挑战（高亮）
                        completed: '#10B981',    // 绿色 - 已完成
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .challenge-card {
                transition: all 0.3s ease;
                position: relative;
                cursor: pointer;
                overflow: hidden;
            }
            .challenge-card:hover:not(.locked) {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.5);
            }
            .locked {
                cursor: not-allowed;
                filter: grayscale(0.7);
            }
            .current-highlight {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
                70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
                100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
            }
            .lock-icon {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 3rem;
                color: #FBBF24;
                opacity: 0.8;
                text-shadow: 0 0 10px rgba(0,0,0,0.5);
            }
            .completed-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                background-color: #10B981;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
            }
            .timer-display {
                font-family: 'Courier New', monospace;
                letter-spacing: 2px;
            }
            .modal-backdrop {
                backdrop-filter: blur(5px);
            }
            .audio-wave {
                display: flex;
                align-items: center;
                gap: 2px;
                height: 20px;
                margin-top: 10px;
            }
            .audio-bar {
                width: 3px;
                background-color: #8B5CF6;
                border-radius: 3px;
                animation: wave 1s infinite ease-in-out;
            }
            @keyframes wave {
                0%, 100% { height: 5px; }
                50% { height: 20px; }
            }
            .audio-bar:nth-child(2) { animation-delay: 0.1s; }
            .audio-bar:nth-child(3) { animation-delay: 0.2s; }
            .audio-bar:nth-child(4) { animation-delay: 0.3s; }
            .audio-bar:nth-child(5) { animation-delay: 0.4s; }
            .bagua-spin {
                animation: slowSpin 20s linear infinite; /* 减慢旋转速度 */
            }
            @keyframes slowSpin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .bagua-container {
                display: flex;
                justify-content: center;
                align-items: center;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-white">
    <!-- 游戏容器 -->
    <div class="container mx-auto px-4 py-6 sm:py-8 max-w-6xl">
        <!-- 游戏头部 -->
        <header class="mb-6 sm:mb-8 text-center">
            <h1 class="text-[clamp(1.5rem,5vw,3rem)] font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary mb-3 sm:mb-4">
                八卦密室逃脱
            </h1>
            
            <div class="flex flex-wrap justify-center items-center gap-4 sm:gap-6 bg-gray-800/50 backdrop-blur-sm rounded-full px-4 sm:px-6 py-2 sm:py-3 mb-4 sm:mb-6">
                <div class="flex items-center gap-2">
                    <i class="fa fa-key text-yellow-400 text-xl"></i>
                    <span id="current-key" class="text-base sm:text-lg font-semibold">当前钥匙：<span id="current-gua" class="text-current">乾</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fa fa-clock-o text-blue-400 text-xl"></i>
                    <span id="game-timer" class="timer-display text-base sm:text-lg font-semibold">00:00:00</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fa fa-check-circle text-green-400 text-xl"></i>
                    <span id="completed-count" class="text-base sm:text-lg font-semibold">已完成：0/8</span>
                </div>
            </div>
            
            <!-- 游戏说明 -->
            <div id="game-intro" class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-4 sm:p-6 shadow-lg border border-gray-700/50 mb-6 sm:mb-8">
                <h2 class="text-xl font-bold mb-3 text-primary">游戏说明</h2>
                <p class="text-gray-300 mb-3 sm:mb-4">你被困在一个八卦密室中，已找到第一道门的钥匙（上面的字是八卦中的一个）。打开相应的门，完成任务后将得到新钥匙，直到打开8道门，完成8个任务，即可成功逃脱。（声明：游戏素材来源于《呆话西游》）</p>
                <p class="text-gray-300 mb-4"><span class="text-current font-bold">提示：</span>当前钥匙对应的门会以高亮颜色显示</p>
                <button id="start-game" class="bg-primary hover:bg-primary/80 text-white font-bold py-2 px-6 rounded-full transition-all duration-300">
                    开始游戏
                </button>
            </div>
        </header>

        <!-- 挑战区域：响应式布局 -->
        <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8 sm:mb-12" id="challenges-container">
            <!-- 挑战卡片将通过JavaScript动态生成 -->
        </main>
    </div>

    <!-- 挑战模态框 -->
    <div id="challenge-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/70 modal-backdrop"></div>
        <div class="relative bg-gray-800 rounded-2xl p-4 sm:p-6 max-w-2xl w-full mx-4 shadow-2xl border border-primary/30 max-h-[90vh] overflow-y-auto">
            <!-- 关闭按钮 -->
            <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <i class="fa fa-times text-xl"></i>
            </button>
            
            <div class="flex flex-col md:flex-row gap-4 sm:gap-6">
                <!-- 角色图片区域 -->
                <div class="w-full md:w-2/5">
                    <div class="bg-gray-700/70 rounded-xl overflow-hidden">
                        <img id="modal-character-image" src="" alt="角色图片" class="w-full h-auto object-cover">
                    </div>
                    <div class="mt-4 text-center">
                        <button id="play-audio" class="bg-primary hover:bg-primary/80 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 flex items-center mx-auto">
                            <i class="fa fa-play mr-2" id="audio-icon"></i> 播放经典语录
                        </button>
                        <!-- 音频播放动画 -->
                        <div class="audio-wave justify-center hidden" id="audio-animation">
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                        </div>
                    </div>
                </div>

                <!-- 输入区域 -->
                <div class="w-full md:w-3/5">
                    <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">
                        挑战：<span id="modal-character-name"></span>
                    </h2>
                    
                    <div class="bg-gray-700/70 rounded-xl p-4 sm:p-5">
                        <h3 class="text-lg font-bold mb-3 flex items-center">
                            <i class="fa fa-comment text-secondary mr-2"></i> 请输入听到的经典语录
                        </h3>
                        
                        <!-- 修改提示文字 -->
                        <div class="text-sm text-gray-400 mb-3 italic">
                            提示：在电脑上可考虑采用语音输入
                        </div>
                        
                        <!-- 显示失败次数和提示 -->
                        <div id="attempts-feedback" class="text-sm text-yellow-400 mb-3 hidden"></div>
                        
                        <div class="mb-4 relative">
                            <textarea id="answer-input" rows="4" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none" 
                                      placeholder="在这里输入经典语录..."></textarea>
                            <button id="voice-input-btn" class="absolute right-3 bottom-3 text-gray-400 hover:text-primary transition-colors">
                                <i class="fa fa-microphone text-lg"></i>
                            </button>
                        </div>
                        
                        <button id="submit-answer" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">
                            提交答案
                        </button>
                        
                        <div id="feedback" class="mt-4 text-center hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通关成功模态框 -->
    <div id="success-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/70 modal-backdrop"></div>
        <div class="relative bg-gray-800 rounded-2xl p-6 sm:p-8 max-w-md w-full mx-4 shadow-2xl border border-success/50 text-center">
            <!-- 确保八卦图始终居中且尺寸放大 -->
            <div class="w-40 sm:w-48 h-40 sm:h-48 mx-auto mb-5 sm:mb-6 bg-gray-700/80 rounded-full border-4 border-success/50 bagua-container">
                <img src="bagua.png" alt="八卦图" class="w-full h-full object-cover rounded-full bagua-spin">
            </div>
            
            <h2 class="text-2xl sm:text-3xl font-bold mb-3 sm:mb-4 text-transparent bg-clip-text bg-gradient-to-r from-success to-primary">
                恭喜通关！
            </h2>
            
            <p class="text-gray-300 mb-5 sm:mb-6">你成功打开了所有八卦门，逃出了密室！</p>
            
            <div class="bg-gray-700/70 rounded-xl p-4 mb-5 sm:mb-6">
                <p class="text-gray-400 mb-2">总用时</p>
                <p id="total-time" class="timer-display text-success text-xl sm:text-2xl font-bold">00:00:00</p>
            </div>
            
            <button id="restart-game" class="w-full bg-primary hover:bg-primary/80 text-white font-bold py-3 px-6 rounded-full transition-all duration-300">
                重新开始游戏
            </button>
        </div>
    </div>

    <!-- 音频元素 -->
    <audio id="challenge-audio" preload="none">
    <audio id="correct-audio" src="correct.mp3" preload="auto">
    <audio id="success-audio" src="success.mp3" preload="auto">

    <script>
        // 游戏数据
        const gameData = {
            characters: {
                '乾': '唐唠鸭',
                '兑': '牛猫王',
                '离': '狂飙鸡',
                '震': '蛙芙蓉',
                '巽': '福禄蛙',
                '坎': '达咩羊',
                '艮': '小苍蝇',
                '坤': '苍蝇妈妈'
            },
            quotes: {  // 经典语录
                '乾': '我的小强要死啦我的小强啊',
                '兑': '红鲤鱼与绿鲤鱼与驴',
                '离': '大王叫我来巡山',
                '震': '当初是你要分开',
                '巽': '呱呱呱呱呱呱呱呱呱呱呱呱呱',
                '坎': '沾点仙露水化身白富美',
                '艮': '钵钵鸡呀钵呀钵钵鸡',
                '坤': '不要讨论这么恶心的话题'
            },
            imagePaths: {
                '乾': 'tanglaoya.gif',
                '兑': 'niumaowang.gif',
                '离': 'kuangbiaoji.gif',
                '震': 'wafurong.gif',
                '巽': 'fuluwa.gif',
                '坎': 'damieyang.gif',
                '艮': 'xiaocangying.gif',
                '坤': 'cangyingmama.gif'
            },
            audioPaths: {
                '乾': 'tanglaoya.mp3',
                '兑': 'niumaowang.mp3',
                '离': 'kuangbiaoji.mp3',
                '震': 'wafurong.mp3',
                '巽': 'fuluwa.mp3',
                '坎': 'damieyang.mp3',
                '艮': 'xiaocangying.mp3',
                '坤': 'cangyingmama.mp3'
            }
        };

        // 游戏状态管理
        let gameState = {
            startTime: null,
            currentKey: null,
            completedChallenges: [],
            totalChallenges: 8,
            isPlaying: false,
            challengeOrder: []  // 存储随机排序的挑战顺序
        };

        // DOM元素
        const dom = {
            currentKeyEl: document.getElementById('current-gua'),
            timerEl: document.getElementById('game-timer'),
            completedCountEl: document.getElementById('completed-count'),
            startGameBtn: document.getElementById('start-game'),
            gameIntroEl: document.getElementById('game-intro'),
            challengesContainer: document.getElementById('challenges-container'),
            challengeModal: document.getElementById('challenge-modal'),
            closeModalBtn: document.getElementById('close-modal'),
            modalCharacterImage: document.getElementById('modal-character-image'),
            modalCharacterName: document.getElementById('modal-character-name'),
            playAudioBtn: document.getElementById('play-audio'),
            audioIcon: document.getElementById('audio-icon'),
            audioAnimation: document.getElementById('audio-animation'),
            answerInput: document.getElementById('answer-input'),
            submitAnswerBtn: document.getElementById('submit-answer'),
            feedbackEl: document.getElementById('feedback'),
            attemptsFeedback: document.getElementById('attempts-feedback'), // 新增：失败次数反馈
            challengeAudio: document.getElementById('challenge-audio'),
            correctAudio: document.getElementById('correct-audio'),
            successAudio: document.getElementById('success-audio'),
            successModal: document.getElementById('success-modal'),
            totalTimeEl: document.getElementById('total-time'),
            restartGameBtn: document.getElementById('restart-game'),
            voiceInputBtn: document.getElementById('voice-input-btn')
        };

        // 当前挑战数据
        let currentChallenge = null;
        let failedAttempts = 0; // 记录失败次数
        // 存储提交按钮的事件处理函数，确保可以正确移除
        let newKeyHandler = null;

        // 初始化游戏
        function initGame() {
            // 清除本地存储
            localStorage.removeItem('baguaEscapeState');
            
            // 生成随机的挑战顺序
            generateRandomChallengeOrder();
            
            // 动态创建挑战卡片
            createChallengeCards();
            
            // 绑定事件监听
            bindEvents();
            
            // 随机选择一个初始钥匙显示在说明中
            const allGua = ['乾', '兑', '离', '震', '巽', '坎', '艮', '坤'];
            const randomGua = allGua[Math.floor(Math.random() * allGua.length)];
            dom.currentKeyEl.textContent = randomGua;
        }

        // 生成随机的挑战顺序
        function generateRandomChallengeOrder() {
            const allGua = ['乾', '兑', '离', '震', '巽', '坎', '艮', '坤'];
            // 随机排序
            gameState.challengeOrder = [...allGua].sort(() => Math.random() - 0.5);
        }

        // 动态创建挑战卡片
        function createChallengeCards() {
            // 清空容器
            dom.challengesContainer.innerHTML = '';
            
            // 根据随机顺序创建卡片
            gameState.challengeOrder.forEach(gua => {
                const character = gameData.characters[gua];
                const imagePath = gameData.imagePaths[gua];
                
                // 创建卡片元素
                const card = document.createElement('div');
                card.className = 'challenge-card locked bg-locked rounded-xl overflow-hidden border-2 border-gray-600';
                card.dataset.gua = gua;
                card.dataset.character = character;
                
                // 卡片内容
                card.innerHTML = `
                    <img src="${imagePath}" alt="${character}" class="w-full h-40 sm:h-48 object-cover">
                    <div class="p-4 bg-gray-800/80">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold">${gua}门</h3>
                            <span class="bg-primary/20 text-primary px-2 py-1 rounded-full text-sm">${character}</span>
                        </div>
                        <p class="text-gray-400 text-sm">需要"${gua}"钥匙才能挑战</p>
                    </div>
                    <i class="fa fa-lock lock-icon"></i>
                    <div class="completed-badge hidden">✓</div>
                `;
                
                // 添加到容器
                dom.challengesContainer.appendChild(card);
            });
        }

        // 开始新游戏
        function startNewGame() {
            // 随机选择第一个钥匙
            const firstKey = gameState.challengeOrder[Math.floor(Math.random() * gameState.challengeOrder.length)];
            
            // 初始化游戏状态
            gameState = {
                startTime: new Date().getTime(),
                currentKey: firstKey,
                completedChallenges: [],
                totalChallenges: 8,
                isPlaying: true,
                challengeOrder: gameState.challengeOrder
            };
            
            // 更新UI
            updateGameUI();
            
            // 隐藏游戏说明
            dom.gameIntroEl.classList.add('hidden');
            
            // 启动计时器
            startTimer();
        }

        // 更新游戏UI
        function updateGameUI() {
            // 更新当前钥匙显示
            dom.currentKeyEl.textContent = gameState.currentKey;
            
            // 更新已完成挑战数量
            dom.completedCountEl.textContent = `${gameState.completedChallenges.length}/${gameState.totalChallenges}`;
            
            // 获取所有挑战卡片
            const challengeCards = document.querySelectorAll('.challenge-card');
            
            // 重置所有卡片状态
            challengeCards.forEach(card => {
                const gua = card.dataset.gua;
                
                // 移除所有状态类
                card.classList.remove('locked', 'bg-locked', 'border-gray-600',
                                    'current', 'current-highlight', 'border-current',
                                    'bg-completed', 'border-success/50');
                
                // 隐藏所有锁图标和完成标记
                card.querySelector('.lock-icon').classList.add('hidden');
                card.querySelector('.completed-badge').classList.add('hidden');
                
                // 标记已完成的挑战
                if (gameState.completedChallenges.includes(gua)) {
                    card.classList.add('bg-completed', 'border-success/50');
                    card.querySelector('.completed-badge').classList.remove('hidden');
                    card.querySelector('p').textContent = "已完成挑战";
                }
                // 高亮显示当前钥匙对应的门
                else if (gua === gameState.currentKey) {
                    card.classList.add('current', 'current-highlight', 'border-current');
                    card.querySelector('h3').classList.add('text-current');
                    card.querySelector('span').classList.remove('bg-primary/20', 'text-primary');
                    card.querySelector('span').classList.add('bg-current/20', 'text-current');
                    card.querySelector('p').textContent = "点击挑战，完成任务获取新钥匙";
                }
                // 锁定状态的门
                else {
                    card.classList.add('locked', 'bg-locked', 'border-gray-600');
                    card.querySelector('.lock-icon').classList.remove('hidden');
                    card.querySelector('h3').classList.remove('text-current');
                    card.querySelector('span').classList.remove('bg-current/20', 'text-current');
                    card.querySelector('span').classList.add('bg-primary/20', 'text-primary');
                    card.querySelector('p').textContent = `需要"${gua}"钥匙才能挑战`;
                }
            });
        }

        // 启动计时器
        function startTimer() {
            function updateTimer() {
                if (!gameState.isPlaying) return;
                
                const now = new Date().getTime();
                const elapsed = now - gameState.startTime;
                
                // 格式化时间
                const hours = Math.floor(elapsed / 3600000).toString().padStart(2, '0');
                const minutes = Math.floor((elapsed % 3600000) / 60000).toString().padStart(2, '0');
                const seconds = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
                
                dom.timerEl.textContent = `${hours}:${minutes}:${seconds}`;
                dom.totalTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // 打开挑战模态框
        function openChallengeModal(gua) {
            currentChallenge = {
                gua: gua,
                character: gameData.characters[gua],
                quote: gameData.quotes[gua],
                image: gameData.imagePaths[gua],
                audio: gameData.audioPaths[gua]
            };
            
            // 重置失败次数
            failedAttempts = 0;
            dom.attemptsFeedback.classList.add('hidden');
            
            // 更新模态框内容
            dom.modalCharacterImage.src = currentChallenge.image;
            dom.modalCharacterImage.alt = currentChallenge.character;
            dom.modalCharacterName.textContent = currentChallenge.character;
            dom.answerInput.value = '';
            dom.feedbackEl.classList.add('hidden');
            
            // 重置提交按钮
            dom.submitAnswerBtn.textContent = '提交答案';
            dom.submitAnswerBtn.disabled = false;
            
            // 确保移除之前的事件处理函数
            if (newKeyHandler) {
                dom.submitAnswerBtn.removeEventListener('click', newKeyHandler);
            }
            
            // 绑定新的提交答案事件
            dom.submitAnswerBtn.addEventListener('click', checkAnswer);
            
            // 重置音频
            dom.challengeAudio.src = currentChallenge.audio;
            dom.audioIcon.classList.remove('fa-pause');
            dom.audioIcon.classList.add('fa-play');
            dom.audioAnimation.classList.add('hidden');
            
            // 显示模态框
            dom.challengeModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 关闭挑战模态框
        function closeChallengeModal() {
            dom.challengeAudio.pause();
            dom.audioIcon.classList.remove('fa-pause');
            dom.audioIcon.classList.add('fa-play');
            dom.audioAnimation.classList.add('hidden');
            
            // 移除事件监听器，防止内存泄漏
            if (newKeyHandler) {
                dom.submitAnswerBtn.removeEventListener('click', newKeyHandler);
                newKeyHandler = null;
            }
            dom.submitAnswerBtn.removeEventListener('click', checkAnswer);
            
            dom.challengeModal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // 播放/暂停音频
        function toggleAudio() {
            if (dom.challengeAudio.paused) {
                dom.challengeAudio.play()
                    .then(() => {
                        dom.audioIcon.classList.remove('fa-play');
                        dom.audioIcon.classList.add('fa-pause');
                        dom.audioAnimation.classList.remove('hidden');
                    })
                    .catch(error => {
                        showFeedback('播放音频失败，请重试', 'error');
                    });
            } else {
                dom.challengeAudio.pause();
                dom.audioIcon.classList.remove('fa-pause');
                dom.audioIcon.classList.add('fa-play');
                dom.audioAnimation.classList.add('hidden');
            }
        }

        // 音频播放结束处理
        dom.challengeAudio.addEventListener('ended', () => {
            dom.audioIcon.classList.remove('fa-pause');
            dom.audioIcon.classList.add('fa-play');
            dom.audioAnimation.classList.add('hidden');
        });

        // 语音输入功能
        function startVoiceInput() {
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                showFeedback('抱歉，您的浏览器不支持语音输入功能', 'error');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            // 更改按钮样式表示正在录音
            dom.voiceInputBtn.classList.remove('text-gray-400', 'hover:text-primary');
            dom.voiceInputBtn.classList.add('text-red-500', 'animate-pulse');
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                dom.answerInput.value = transcript;
                resetVoiceButton();
            };
            
            recognition.onend = resetVoiceButton;
            recognition.onerror = (event) => {
                showFeedback(`语音识别出错: ${event.error}`, 'error');
                resetVoiceButton();
            };
            
            recognition.start();
            
            function resetVoiceButton() {
                dom.voiceInputBtn.classList.remove('text-red-500', 'animate-pulse');
                dom.voiceInputBtn.classList.add('text-gray-400', 'hover:text-primary');
            }
        }

        // 检查答案 - 实现渐进式提示功能
        function checkAnswer() {
            if (!currentChallenge) return;
            
            const userAnswer = dom.answerInput.value.trim();
            const correctAnswer = currentChallenge.quote.trim();
            
            if (!userAnswer) {
                showFeedback('请输入经典语录内容', 'error');
                return;
            }
            
            // 答案验证逻辑 - 忽略标点符号
            const normalizeAnswer = (str) => {
                // 移除所有标点和空格
                let normalized = str.replace(/[，。、, .\s!?！？]/g, '').toLowerCase();
                // 移除所有可能的特殊字符
                normalized = normalized.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '');
                return normalized;
            };
            
            const normalizedUserAnswer = normalizeAnswer(userAnswer);
            const normalizedCorrectAnswer = normalizeAnswer(correctAnswer);
            
            // 只有完全匹配才能通过
            if (normalizedUserAnswer === normalizedCorrectAnswer) {
                // 答案正确
                dom.correctAudio.play();
                showFeedback('答案正确！点击上方按钮获得新钥匙', 'success');
                
                // 移除之前的事件监听
                dom.submitAnswerBtn.removeEventListener('click', checkAnswer);
                
                // 更新按钮文本为"获得新钥匙"
                dom.submitAnswerBtn.textContent = '获得新钥匙';
                dom.submitAnswerBtn.disabled = false;
                
                // 定义新的事件处理函数
                newKeyHandler = () => {
                    // 标记为已完成
                    gameState.completedChallenges.push(currentChallenge.gua);
                    
                    // 生成新钥匙
                    const remainingGua = gameState.challengeOrder.filter(
                        gua => !gameState.completedChallenges.includes(gua)
                    );
                    
                    if (remainingGua.length > 0) {
                        gameState.currentKey = remainingGua[Math.floor(Math.random() * remainingGua.length)];
                        closeChallengeModal();
                        updateGameUI();
                    } else {
                        // 所有挑战都完成了
                        gameState.isPlaying = false;
                        closeChallengeModal();
                        dom.successModal.classList.remove('hidden');
                        dom.successAudio.play().catch(e => console.error(e));
                        document.body.style.overflow = 'hidden';
                    }
                };
                
                // 绑定新的事件处理函数
                dom.submitAnswerBtn.addEventListener('click', newKeyHandler);
            } else {
                // 答案错误 - 增加失败次数并显示相应提示
                failedAttempts++;
                let hint = '';
                let attemptsText = '';
                
                // 根据失败次数显示不同长度的提示
                if (failedAttempts === 1) {
                    hint = correctAnswer.substring(0, 3) + "...";
                    attemptsText = `已尝试 ${failedAttempts} 次，提示：${hint}`;
                } else if (failedAttempts === 2) {
                    hint = correctAnswer.substring(0, 4) + "...";
                    attemptsText = `已尝试 ${failedAttempts} 次，提示：${hint}`;
                } else if (failedAttempts >= 3) {
                    hint = correctAnswer;
                    attemptsText = `已尝试 ${failedAttempts} 次，正确答案：${hint}`;
                }
                
                // 显示失败次数和提示
                dom.attemptsFeedback.textContent = attemptsText;
                dom.attemptsFeedback.classList.remove('hidden');
                
                showFeedback('答案不正确，请再试一次', 'error');
            }
        }

        // 显示反馈信息
        function showFeedback(message, type) {
            dom.feedbackEl.textContent = message;
            dom.feedbackEl.classList.remove('hidden', 'text-green-400', 'text-red-400');
            
            if (type === 'success') {
                dom.feedbackEl.classList.add('text-green-400', 'font-bold');
            } else {
                dom.feedbackEl.classList.add('text-red-400', 'font-bold');
            }
        }

        // 重新开始游戏
        function restartGame() {
            dom.successModal.classList.add('hidden');
            document.body.style.overflow = '';
            
            generateRandomChallengeOrder();
            createChallengeCards();
            dom.gameIntroEl.classList.remove('hidden');
            
            const randomGua = gameState.challengeOrder[Math.floor(Math.random() * gameState.challengeOrder.length)];
            dom.currentKeyEl.textContent = randomGua;
        }

        // 绑定事件监听
        function bindEvents() {
            dom.startGameBtn.addEventListener('click', startNewGame);
            
            // 挑战卡片点击事件委托
            dom.challengesContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.challenge-card');
                if (!card) return;
                
                const gua = card.dataset.gua;
                if (gua === gameState.currentKey && 
                    !gameState.completedChallenges.includes(gua) &&
                    gameState.isPlaying) {
                    openChallengeModal(gua);
                }
            });
            
            dom.closeModalBtn.addEventListener('click', closeChallengeModal);
            dom.playAudioBtn.addEventListener('click', toggleAudio);
            dom.voiceInputBtn.addEventListener('click', startVoiceInput);
            
            // 回车提交答案
            dom.answerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    checkAnswer();
                }
            });
            
            dom.restartGameBtn.addEventListener('click', restartGame);
            
            // 点击模态框背景关闭
            dom.challengeModal.addEventListener('click', (e) => {
                if (e.target === dom.challengeModal) {
                    closeChallengeModal();
                }
            });

            // 响应式调整：窗口大小变化时重新布局
            window.addEventListener('resize', () => {
                // 可以在这里添加特定的响应式调整逻辑
            });
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>